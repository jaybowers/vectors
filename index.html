<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Vector Ship</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    	html, body {
  			width:  100%;
  			height: 100%;
  			margin: 0px;
		}
    </style>
</head>
<body>

<canvas id="astors"></canvas>

<script>
const DEG_TO_RAD = Math.PI / 180;
const RAD_TO_DEG = 180 / Math.PI;

// The maximum is inclusive and the minimum is inclusive 
function getRandomIntInclusive(min, max) {
  var min = Math.ceil(min);
  var max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function Keys() {
	this.keys_pressed = new Set();
	this.init = function() {
		document.addEventListener('keydown', (event) => {
			console.log(event.type + ' ' + event.key);
			this.keys_pressed.add(event.key);
			call(objects, o => o.keydown, o => o.keydown({ key: event.key }));
		});
		document.addEventListener('keyup', (event) => {
//			console.log(event.type + ' ' + event.key);
			this.keys_pressed.delete(event.key);
			call(objects, o => o.keyup, o => o.keyup({ key: event.key }));
		});
	};
	this.pressed = function(key) {
		return this.keys_pressed.has(key);
	}
}
function Debug()  {
	this.on = false;
	this.onKeys = function (keys) {
		if (keys.pressed('d')) {
			this.on = ! this.on;
		}
	}
	this.draw = function(ctx) {
		if (this.on) {
			ctx.fillText(
			   	  'canvas.height = ' + canvas.height
				+ ' canvas.width = ' + canvas.width,
			12, 12);
			call(objects, o => o.debug, o => o.debug(ctx));
		}
	} 
}
function Vector(magnitude, direction) {
	this.magnitude =  magnitude;
	this.direction = direction;
	this.x = this.magnitude * Math.cos( DEG_TO_RAD * this.direction );
	this.y = this.magnitude * Math.sin( DEG_TO_RAD * this.direction );
	this.add = function (other) {
		var sx = this.x,
		    sy = this.y;

		var rx = sx + other.x;
		var ry = sy + other.y;

		var magnitude = Math.sqrt( (rx * rx) + (ry * ry) );
		var direction = Math.atan2( ry, rx ) * RAD_TO_DEG;

		return new Vector(magnitude, direction);
	};
}
function Coords(x, y, rotation, direction, speed) {
	// the x position on the canvas
	this.x = x;
	// the y position on the canvas
	this.y = y;
	// the rotated angle of the object
	this.rotation = rotation;
	// the direction that the object is traveling in
	this.direction = direction;
	// the speed of the movement
	this.speed = speed;
}
function VectorObject(coords) {
	this.coords = coords;
}
VectorObject.prototype.debug = function( ctx ) {
	var coords = this.coords;
	ctx.save();
	ctx.translate( coords.x, coords.y );
	ctx.fillText(
			   'x = ' + coords.x.toFixed(1)
			+ ' y = ' + coords.y.toFixed(1)
			+ ' rotation = ' + coords.rotation.toFixed(2)
			+ ' speed = ' + coords.speed.toFixed(2)
			+ ' direction = ' + coords.direction.toFixed(2), -50, 50);
	ctx.restore();
}
VectorObject.prototype.drawObject = function( ctx ) {
	// do nothing
}
VectorObject.prototype.draw = function( ctx ) {
	var coords = this.coords;
	var x = coords.x,
	    y = coords.y,
	    rotation = coords.rotation;
	ctx.save();
	ctx.translate( x, y );
	ctx.rotate( DEG_TO_RAD * rotation );
	this.drawObject( ctx );
	ctx.restore();
}
VectorObject.prototype.moveObject = function() {
	// do nothing
}
VectorObject.prototype.move = function() {
	var coords = this.coords;
	var x = coords.x,
	    y = coords.y,
	    direction = coords.direction,
	    speed = coords.speed;
	coords.x = x + ( speed * Math.cos( DEG_TO_RAD * direction ) );
	coords.y = y + ( speed * Math.sin( DEG_TO_RAD * direction ) );
	if (coords.x > canvas.width) {
		coords.x = 0;
	}
	if (coords.x < 0) {
		coords.x = canvas.width;
	}
	if (coords.y > canvas.height) {
		coords.y = 0;
	}
	if (coords.y < 0) {
		coords.y = canvas.height;
	}
	this.moveObject();
}
function Asteroid() {
	VectorObject.call(this, new Coords(
		getRandomIntInclusive( 0, canvas.width ),
		getRandomIntInclusive( 0, canvas.height ),
		getRandomIntInclusive( 0, 360 ),
		getRandomIntInclusive( 0, 360 ),
		Math.random()
	));
	this.drawObject = function( ctx ) {
		ctx.beginPath();
		ctx.moveTo(25, 25);
		ctx.lineTo(-25, 25);
		ctx.lineTo(-25, -25);
		ctx.lineTo(25, -25);
		ctx.closePath();
		ctx.stroke();
	}
	this.moveObject = function() {
		this.rotation--;
	}

	this.debug = function( ctx ) {
		ctx.save();
		ctx.translate( this.x, this.y );
		ctx.fillText(
				   'x = ' + this.x.toFixed(1)
				+ ' y = ' + this.y.toFixed(1)
				+ ' rotation = ' + this.rotation.toFixed(2)
				+ ' speed = ' + this.speed.toFixed(2)
				+ ' direction = ' + this.direction.toFixed(2), -50, 50);
		ctx.restore();
	}
}
Asteroid.prototype = Object.create(VectorObject.prototype);
Asteroid.prototype.constructor = Asteroid;

function Ship() {
	VectorObject.call(this, new Coords(
		Math.abs( canvas.width / 2),
		Math.abs( canvas.height / 2),
		270,
		270,
		0
	));
	this.drawObject = function(ctx) {
		ctx.beginPath();
		ctx.moveTo(25, 0);
		ctx.lineTo(-25, -20);
		ctx.lineTo(-5, 0);
		ctx.lineTo(-25, 20);
		ctx.closePath();
    	ctx.stroke();
	}
	this.onKeys = function(keys) {
		var coords = this.coords;
		if (keys.pressed('ArrowRight')) {
			coords.rotation += 3;
		}
		if (keys.pressed('ArrowLeft')) {
			coords.rotation -= 3;
		}
		if (keys.pressed('ArrowUp')) {
			this.thrust(coords.rotation, 0.1);
		}
		if (keys.pressed(' ')) {
			this.fire();
        }
	}
	this.thrust = function(direction, amount) {
		var thrustVector = new Vector(amount, direction);
		var shipVector = new Vector(this.coords.speed, this.coords.direction);

		var newShipVector = shipVector.add(thrustVector);

		this.coords.speed = newShipVector.magnitude;
		this.coords.direction = newShipVector.direction;
	}
    this.fire = function() {
        objects.add(new Projectile(this.coords.x, this.coords.y, this.coords.rotation, this.coords.speed + 5));
    }
}
Ship.prototype = Object.create(VectorObject.prototype);
Ship.prototype.constructor = Ship;
function Projectile(x, y, direction, speed) {
	VectorObject.call(this, new Coords(
		x,
		y,
		direction,
		direction,
		speed
	));
    this.life = 100;
	this.drawObject = function(ctx) {
		ctx.beginPath();
		ctx.moveTo(25, 0);
		ctx.lineTo(30, 0);
		ctx.stroke();
	}
}
Projectile.prototype = Object.create(VectorObject.prototype);
Projectile.prototype.constructor = Projectile;

function init() {
	keys.init();
}
function run() {
	var ctx = canvas.getContext("2d");
	call(objects, o => 'onKeys' in o, o => o.onKeys(keys));
	call(objects, o => 'move' in o, o => o.move());
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	call(objects, o => 'draw' in o, o => o.draw(ctx));
}
function call(objects, pred, callback) {
	for (let object of objects) {
		if (pred(object)) {
			callback(object);
		}
	}	
}

var canvas = document.getElementById("astors");
canvas.width  = window.innerWidth;
canvas.height = window.innerHeight;

var keys = new Keys();

var objects = new Set();
objects.add(new Debug());
objects.add(new Ship());
for (i = 0; i < 10; i++) {
	objects.add(new Asteroid());
}

init();
setInterval(run, 10);

</script>

</body>
</html>
